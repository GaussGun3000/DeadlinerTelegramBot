# Deadliner BOT
Бот предназначен для группового контроля дедлайнов (один список на всех).Каждый пользователь можно отдельно сохранять список выполенных заданий.

Проект (Telegram бот) написан на python 3.9 c использованием posgreSQL 14 в качестве БД и heroku в качестве хостинга.

Дисклеймер: проект писался до изучения мной каких-либо паттернов, потому код не самый структурированный и не везде учитывал возможное расширение.

### Стек
Вообще, знания python 3.x и основ любого SQL достаточно для работы, но далее приведен список всего, что использовалось (отсортировано по убыванию важности).

Для управления телеграм ботом используется библиотека *PyTelegrambotAPI*. 

Для управления базой данных **posgreSQL** - *psycopg2*.

В качестве хостинга - *heroku* на бесплатном тарифе, для деплоя нужно знать самые основы *git* (Сейчас регистрация новых аккаунтов из России запрещена, понадобится VPN. Либо можно разместиться на любой виртуальной машине). Также понадобятся бесплатные аддоны на heroku: *herokuPostgres* (БД) , *Papertail* (логи), *Airbrake* (отлов ошибок).

Для структурирования заданий(дедлайнов) важен модуль *datetime* (для махинаций с временными поясами - *pytz*). 

Для отправки уведомлений - *Threading* (вообще можно выкинуть его и воткнуть любой scheduler, так наверное даже лучше будет).

Внешние модули перечислены в requirements.txt

### Краткая документация
Комментарии в коде достаточно подробные, но написаны на английском. Хотя каждый уважающий себя программист должен знать английский на этом уровне, какие-то моменты
проясню и здесь.

В файле *main.py* задается поведение бота и вход в программу (запуск бота в терминале - командой python main.py). Сам бот запускается в рекурсивном цикле (функция exception_handler), который предусматривает перезапуск бота до двух раз (по умолчанию, изменяется в config.py) между рестартами heroku (происходит раз в сутки). Чтобы не перезапускать бота вручную от каждого случайного вылета по connection timeout. Параллельно поллингу бота, запускается цикл с проверкой истечения срока дедлайна и отправкой уведомлений.

**Про уведомления:** они настроены приходить за 7, 3 и 1 день до истечения срока дедлайна каждому подписчику, НЕ отметившему задание как выполненное. Статус уведомления сохраняется в параметр notified каждого объекта Deadline: 0 значит уведомлений ещё не было, 1 - уведомление по дедлайну было за 1 день до истечения, 3 - за 3 дня, 7 - за 7 дней. Каждые config.PERIOD секунд происходит проверка.

В файле *my_collections* собраны побочные функции по типу конфигураторов клавиатур для телеграм, преобразователей форматов времени и подобные. 

В файле *config.py* перечислены константы, например, токен бота, тексты сообщений, интервал между проверками для отправки уведомлений и другие (комментарии везде оставлены)

В файле *database.py* осуществляется управление базой данных (также определены классы-модели таблиц deadlines и subscribers). 
#### Структура БД:
            
Колонны (поля) таблицы deadlines:          
|Название    |   Тип    |              Описание 
|------------|----------|-------------------------------------------------
dl_id       |  integer | Уникальный номер. PRIMARY KEY, autoincrement +1
subject     |  text    | Предмет дедлайна
task        |  text    | Описание задания
notified    |  integer | Состояние уведомления подписчиков о дедлайне (0/7/3/1)
date        |  real    | Дата истечения

Колонны (поля) таблицы subscribers:
Название    |   Тип     |              Описание 
|------------|-----------|-------------------------------------------------
user_id     |  numeric  | Цифровой ID пользователя телеграм. PRIMARY KEY
marked_done | integer[] | Номера дедлайнов, отмеченных как выполненные

Для обращения к БД используются функции save_<имя таблицы>. В функцию передается добавляемый/изменяемый/удаляемый объект класса, соответствующего таблице и число, обозначающее действие: 0 - добавить, 1 - удалить, 2 - изменить.
Все данные загружаются функцией load(). 
Класс-модель таблицы может содержать дополнительные поля и методы, упрощающие работу с данными, касающимися этого класса, внутри скриптов.

### Особенности
Пользоваться ботом (кроме /start и /get_my_id) могут только подтвержденные пользователи. Добавление в список подтвержденных пользователей происходит путем добавления ID пользователя в список VERIFIED_USERS в config.py. Вручную. Изначально это казалось высшей степенью безопасности, чтобы никто не увидел ~~какие клички в вашей группе дают преподам и предметам~~ то, чего не нужно. В группе людей немного, можно и ручками добавить. Но факту это лишь проявление лени, дабы не делать нормальную верификацию через интерфейс бота. Админы добавляются так же (только в список ADMINS), но это уже резонно.
У админов есть свои команды (они могут их смотреть через /admin_help) - это /edit - поменять дату дедлайна, и /announce - объявление для подписчиков бота. Также удалить они могут любой дедлайн.

Для беспрерывной бесплатной работы бота на heroku нужно обзавестись VPN (для регистрации, да и аддоны не хотят открываться на российских IP), а также виртуальной картой неподсанкционного банка (нужно привязать карточку к heroku для подтверждения личности и получения дополнительных бесплатных часов в месяц. Ну либо думать над засыпанием скриптов)
Либо можно уйти на любую виртуалку, но это не бесплатно, настраивать дольше (даже с учётом танцев с бубном вокруг регистрации), переделывать систему логгинга с stdout 
на файл.

P.S. Для моих одногруппников, что пожелают добавить в бота фич. Пишите мне в телегу или вк. Буду рад, конечно, если до деплоя сделаете всё сами, но и помочь буду не против.
